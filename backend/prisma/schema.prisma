// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= USER MODEL =============
model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  password     String
  name         String
  role         UserRole  @default(EMPLOYEE)
  department   String
  position     String?
  phone        String?
  avatar       String?
  status       UserStatus @default(ACTIVE)
  language     String    @default("en")
  joinDate     DateTime? @default(now())
  
  // Manager relationship (self-referencing)
  managerId    Int?
  manager      User?     @relation("ManagedBy", fields: [managerId], references: [id])
  subordinates User[]    @relation("ManagedBy")
  
  // Leave relationships
  leaves       Leave[]   @relation("EmployeeLeaves")
  leavesManaged Leave[]  @relation("ManagerLeaves") // Leaves this manager approved
  leavesHRApproved Leave[] @relation("HRLeaves") // Leaves this HR admin approved
  
  // Leave balances
  leaveBalances LeaveBalance[]
  
  // Notifications
  notifications Notification[]
  
  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Indexes
  @@index([managerId])
  @@index([department])
  @@index([status])
  @@index([role])
}

enum UserRole {
  EMPLOYEE
  MANAGER
  HR_ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TERMINATED
}

// ============= LEAVE TYPE MODEL =============
model LeaveType {
  id                   Int        @id @default(autoincrement())
  name                 String     @unique
  maxDays              Int        @default(15)
  description          String?
  color                String?    @default("#3B82F6")
  requiresHRApproval   Boolean    @default(true)
  carryOver            Boolean    @default(false)
  requiresApproval     Boolean    @default(true)
  isActive             Boolean    @default(true)
  
  // Relationships
  leaves               Leave[]
  leaveBalances        LeaveBalance[]
  
  // Timestamps
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

// ============= LEAVE MODEL =============
model Leave {
  id                 Int           @id @default(autoincrement())
  employeeId         Int
  leaveTypeId        Int
  startDate          DateTime
  endDate            DateTime
  days               Int           // Total days of leave
  reason             String
  status             LeaveStatus   @default(PENDING_MANAGER)
  currentApprover    String?       @default("MANAGER") // "MANAGER", "HR", "SYSTEM"
  
  // Approval tracking
  appliedDate        DateTime      @default(now())
  managerApproved    Boolean?      @default(false)
  managerApprovedBy  Int?
  managerApprovedDate DateTime?
  managerNotes       String?
  
  hrApproved         Boolean?      @default(false)
  hrApprovedBy       Int?
  hrApprovedDate     DateTime?
  hrNotes            String?
  
  // Rejection tracking
  rejectedBy         Int?
  rejectedDate       DateTime?
  rejectionReason    String?
  
  // Relationships
  employee           User          @relation("EmployeeLeaves", fields: [employeeId], references: [id])
  leaveType          LeaveType     @relation(fields: [leaveTypeId], references: [id])
  manager            User?         @relation("ManagerLeaves", fields: [managerApprovedBy], references: [id])
  hrAdmin            User?         @relation("HRLeaves", fields: [hrApprovedBy], references: [id])
  
  // Timestamps
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  
  // Indexes
  @@index([employeeId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([managerApprovedBy])
  @@index([hrApprovedBy])
  @@unique([employeeId, startDate, endDate])
}

enum LeaveStatus {
  PENDING_MANAGER
  PENDING_HR
  APPROVED        // Manager approved (1st step)
  HR_APPROVED     // HR approved (2nd step - final)
  REJECTED
  CANCELLED
}

// ============= LEAVE BALANCE MODEL =============
model LeaveBalance {
  id            Int     @id @default(autoincrement())
  userId        Int
  leaveTypeId   Int
  year          Int     @default(2024)
  totalDays     Int     @default(0)
  usedDays      Int     @default(0)
  remainingDays Int     @default(0)
  
  // Relationships
  user          User    @relation(fields: [userId], references: [id])
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id])
  
  // Composite unique constraint
  @@unique([userId, leaveTypeId, year])
  
  // Indexes
  @@index([userId])
  @@index([leaveTypeId])
  @@index([year])
}

// ============= NOTIFICATION MODEL =============
model Notification {
  id           Int             @id @default(autoincrement())
  userId       Int
  type         NotificationType
  title        String
  message      String
  actionUrl    String?
  relatedId    String?         // Related entity ID (e.g., leaveId)
  isRead       Boolean         @default(false)
  priority     NotificationPriority @default(MEDIUM)
  
  // Relationships
  user         User            @relation(fields: [userId], references: [id])
  
  // Timestamps
  createdAt    DateTime        @default(now())
  readAt       DateTime?
  
  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}

enum NotificationType {
   LEAVE_PENDING
  LEAVE_APPROVED
  LEAVE_REJECTED
  SYSTEM_ALERT
  PASSWORD_RESET
  PROFILE_UPDATE
  LEAVE_REMINDER
  PASSWORD_CHANGE  // Add this line
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============= SYSTEM SETTINGS MODEL =============
model SystemSettings {
  id          Int       @id @default(autoincrement())
  key         String    @unique
  value       String
  description String?
  category    String    @default("general")
  isPublic    Boolean   @default(false)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Indexes
  @@index([category])
  @@index([isPublic])
}

// ============= HOLIDAY MODEL (Optional) =============
model Holiday {
  id          Int       @id @default(autoincrement())
  name        String
  date        DateTime
  description String?
  recurring   Boolean   @default(true)
  country     String?   @default("Ethiopia")
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Indexes
  @@index([date])
  @@index([recurring])
}
