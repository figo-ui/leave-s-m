// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "audit"] // Remove multiSchema if not needed
}

// Remove or comment out the multiSchema preview feature
// generator client {
//   provider = "prisma-client-js"
//   previewFeatures = ["multiSchema"]
// }

// ============= ENUMS =============
enum UserRole {
  EMPLOYEE
  MANAGER
  HR_ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TERMINATED
}

enum LeaveStatus {
  PENDING_MANAGER
  PENDING_HR
  APPROVED
  HR_APPROVED
  REJECTED
  CANCELLED
}

enum NotificationType {
  LEAVE_PENDING
  LEAVE_APPROVED
  LEAVE_REJECTED
  SYSTEM_ALERT
  PASSWORD_RESET
  PROFILE_UPDATE
  LEAVE_REMINDER
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// ============= USER MODEL =============
model User {
  id              Int       @id @default(autoincrement())
  employeeCode    String?   @unique @db.VarChar(20)
  email           String    @unique @db.VarChar(255)
  password        String    @db.VarChar(255)
  name            String    @db.VarChar(100)
  role            UserRole  @default(EMPLOYEE)
  department      String    @db.VarChar(100)
  position        String?   @db.VarChar(100)
  phone           String?   @db.VarChar(20)
  avatar          String?   @db.VarChar(500)
  status          UserStatus @default(ACTIVE)
  joinDate        DateTime? @default(now())
  lastLoginAt     DateTime?
  passwordChangedAt DateTime?

  // Manager relationship
  managerId       Int?
  manager         User?     @relation("ManagedBy", fields: [managerId], references: [id])
  subordinates    User[]    @relation("ManagedBy")

  // Leave relationships
  leaves          Leave[]   @relation("EmployeeLeaves")
  leavesManaged   Leave[]   @relation("ManagerLeaves")
  leavesHRApproved Leave[]  @relation("HRLeaves")

  // Leave balances
  leaveBalances   LeaveBalance[]

  // Notifications
  notifications   Notification[]

  // Audit logs
  auditLogs       AuditLog[]

  // Department relationship (if using Department model)
  departmentId    Int?
  departmentRel   Department? @relation("UserDepartment", fields: [departmentId], references: [id])

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? @map("deleted_at")

  // Indexes - REMOVE @@fulltext
  @@index([managerId])
  @@index([department])
  @@index([status])
  @@index([role])
  @@index([createdAt])
  @@index([email])
  @@index([employeeCode])
  @@index([status, role])
  @@index([department, status])
  @@unique([employeeCode], map: "idx_user_employee_code")
}

// ============= LEAVE TYPE MODEL =============
model LeaveType {
  id                   Int        @id @default(autoincrement())
  name                 String     @unique @db.VarChar(100)
  code                 String     @unique @db.VarChar(20)
  maxDays              Int        @default(15)
  minDays              Int        @default(0)
  description          String?    @db.Text
  color                String?    @default("#3B82F6") @db.VarChar(7)
  requiresHRApproval   Boolean    @default(true)
  requiresManagerApproval Boolean @default(true)
  carryOver            Boolean    @default(false)
  carryOverLimit       Int?       @default(5)
  requiresDocument     Boolean    @default(false)
  documentTypes        String[]
  isActive             Boolean    @default(true)
  order                Int        @default(0)
  year                 Int        @default(2024)

  // Relationships
  leaves               Leave[]
  leaveBalances        LeaveBalance[]

  // Timestamps
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  deletedAt            DateTime?  @map("deleted_at")

  // Indexes - REMOVE @@fulltext
  @@index([isActive])
  @@index([name])
  @@index([code])
  @@index([year])
  @@index([isActive, year])
}

// ============= LEAVE MODEL =============
model Leave {
  id                 Int           @id @default(autoincrement())
  leaveNumber        String        @unique @db.VarChar(50)
  employeeId         Int
  leaveTypeId        Int
  startDate          DateTime
  endDate            DateTime
  days               Float
  reason             String        @db.Text
  status             LeaveStatus   @default(PENDING_MANAGER)
  currentApprover    String?       @db.VarChar(50) @default("MANAGER")
  workflowStage      Int           @default(1)

  // Approval tracking
  appliedDate        DateTime      @default(now())
  managerApproved    Boolean?      @default(false)
  managerApprovedBy  Int?
  managerApprovedDate DateTime?
  managerNotes       String?       @db.Text

  hrApproved         Boolean?      @default(false)
  hrApprovedBy       Int?
  hrApprovedDate     DateTime?
  hrNotes            String?       @db.Text

  // Rejection tracking
  rejectedBy         Int?
  rejectedDate       DateTime?
  rejectionReason    String?       @db.Text

  // Cancellation
  cancelledBy        Int?
  cancelledDate      DateTime?
  cancellationReason String?       @db.Text

  // Document attachments
  attachmentUrl      String?       @db.VarChar(500)
  documentType       String?       @db.VarChar(50)

  // Emergency contact
  emergencyContact   String?       @db.VarChar(100)
  emergencyPhone     String?       @db.VarChar(20)

  // Relationships
  employee           User          @relation("EmployeeLeaves", fields: [employeeId], references: [id])
  leaveType          LeaveType     @relation(fields: [leaveTypeId], references: [id])
  manager            User?         @relation("ManagerLeaves", fields: [managerApprovedBy], references: [id])
  hrAdmin            User?         @relation("HRLeaves", fields: [hrApprovedBy], references: [id])
  comments           Comment[]

  // Timestamps
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  deletedAt          DateTime?     @map("deleted_at")

  // Indexes
  @@index([employeeId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([managerApprovedBy])
  @@index([hrApprovedBy])
  @@index([appliedDate])
  @@index([status, startDate])
  @@index([employeeId, status])
  @@index([employeeId, startDate, endDate])
  @@index([status, currentApprover])
  @@index([employeeId, leaveTypeId, startDate])
  @@index([status, workflowStage])
  @@unique([employeeId, startDate, endDate], map: "idx_leave_no_overlap")
  @@map("leaves")
}

// ============= LEAVE BALANCE MODEL =============
model LeaveBalance {
  id            Int     @id @default(autoincrement())
  userId        Int
  leaveTypeId   Int
  year          Int     @default(2024)
  totalDays     Float   @default(0)
  usedDays      Float   @default(0)
  remainingDays Float   @default(0)
  carriedOver   Float   @default(0)
  adjustedDays  Float   @default(0)

  // Audit fields
  lastUpdatedBy Int?
  lastUpdatedAt DateTime @default(now())
  notes         String?  @db.Text

  // Relationships
  user          User    @relation(fields: [userId], references: [id])
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id])

  // Composite unique constraint
  @@unique([userId, leaveTypeId, year], map: "idx_balance_user_type_year")

  // Indexes
  @@index([userId])
  @@index([leaveTypeId])
  @@index([year])
  @@index([remainingDays])
  @@index([userId, year])
  @@index([leaveTypeId, year])
  @@map("leave_balances")
}

// ============= NOTIFICATION MODEL =============
model Notification {
  id           Int                 @id @default(autoincrement())
  userId       Int
  type         NotificationType
  title        String              @db.VarChar(200)
  message      String              @db.Text
  actionUrl    String?             @db.VarChar(500)
  relatedId    String?             @db.VarChar(100)
  isRead       Boolean             @default(false)
  priority     NotificationPriority @default(MEDIUM)
  scheduledAt  DateTime?
  expiresAt    DateTime?

  // Relationships
  user         User                @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt    DateTime            @default(now())
  readAt       DateTime?

  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
  @@index([priority])
  @@index([userId, isRead])
  @@index([scheduledAt])
  @@index([expiresAt])
  @@index([userId, isRead, createdAt])
  @@index([userId, type, isRead])
  @@map("notifications")
}

// ============= COMMENT MODEL =============
model Comment {
  id           Int       @id @default(autoincrement())
  leaveId      Int
  userId       Int
  content      String    @db.Text
  isInternal   Boolean   @default(false)

  // Relationships
  leave        Leave     @relation(fields: [leaveId], references: [id])
  user         User      @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Indexes
  @@index([leaveId])
  @@index([userId])
  @@index([createdAt])
  @@index([leaveId, isInternal])
  @@map("comments")
}

// ============= SYSTEM SETTINGS MODEL =============
model SystemSettings {
  id          Int       @id @default(autoincrement())
  key         String    @unique @db.VarChar(100)
  value       String    @db.Text
  description String?   @db.VarChar(500)
  category    String    @default("general") @db.VarChar(50)
  dataType    String    @default("string") @db.VarChar(20)
  isPublic    Boolean   @default(false)
  isRequired  Boolean   @default(false)
  validValues String[]

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  updatedBy   Int?

  // Indexes
  @@index([category])
  @@index([key])
  @@index([isPublic])
  @@index([category, isPublic])
  @@map("system_settings")
}

// ============= HOLIDAY MODEL =============
model Holiday {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(200)
  description String?   @db.Text
  date        DateTime
  year        Int
  type        String    @default("PUBLIC") @db.VarChar(50)
  isRecurring Boolean   @default(true)
  country     String?   @default("Ethiopia") @db.VarChar(100)
  region      String?   @db.VarChar(100)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Indexes
  @@index([date])
  @@index([year])
  @@index([isRecurring])
  @@index([type])
  @@index([country])
  @@index([date, country])
  @@unique([name, date, country], map: "idx_holiday_unique")
  @@map("holidays")
}

// ============= WORKING DAYS MODEL =============
model WorkingDay {
  id          Int       @id @default(autoincrement())
  dayOfWeek   DayOfWeek
  isWorking   Boolean   @default(true)
  startTime   String?   @db.VarChar(8)
  endTime     String?   @db.VarChar(8)
  breakStart  String?   @db.VarChar(8)
  breakEnd    String?   @db.VarChar(8)
  year        Int       @default(2024)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Indexes
  @@index([dayOfWeek])
  @@index([isWorking])
  @@index([year])
  @@unique([dayOfWeek, year], map: "idx_working_day_unique")
  @@map("working_days")
}

// ============= AUDIT LOG MODEL =============
model AuditLog {
  id          Int         @id @default(autoincrement())
  userId      Int?
  action      AuditAction
  entityType  String      @db.VarChar(50)
  entityId    String?     @db.VarChar(100)
  oldData     Json?
  newData     Json?
  ipAddress   String?     @db.VarChar(45)
  userAgent   String?     @db.VarChar(500)
  metadata    Json?

  // Relationships
  user        User?       @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt   DateTime    @default(now())

  // Indexes
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@index([action, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([userId, action, createdAt])
  @@map("audit_logs")
}

// ============= PASSWORD RESET TOKEN MODEL =============
model PasswordResetToken {
  id          Int       @id @default(autoincrement())
  userId      Int
  token       String    @unique @db.VarChar(255)
  expiresAt   DateTime
  used        Boolean   @default(false)

  // Relationships
  user        User      @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt   DateTime  @default(now())
  usedAt      DateTime?

  // Indexes
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([used])
  @@index([userId, used])
  @@map("password_reset_tokens")
}

// ============= API KEY MODEL =============
model ApiKey {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  key         String    @unique @db.VarChar(255)
  userId      Int
  permissions String[]
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  isActive    Boolean   @default(true)

  // Relationships
  user        User      @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Indexes
  @@index([userId])
  @@index([key])
  @@index([isActive])
  @@index([expiresAt])
  @@map("api_keys")
}

// ============= LEAVE POLICY MODEL =============
model LeavePolicy {
  id                      Int       @id @default(autoincrement())
  name                    String    @unique @db.VarChar(100)
  description             String?   @db.Text
  minAdvanceNoticeDays    Int       @default(3)
  maxConsecutiveDays      Int       @default(30)
  allowBackdated          Boolean   @default(false)
  maxBackdatedDays        Int       @default(7)
  allowOverlap            Boolean   @default(false)
  requireDocumentation    Boolean   @default(false)
  approvalWorkflow        String[]
  autoApproveDays         Int?      @default(1)
  isDefault               Boolean   @default(false)

  // Timestamps
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Indexes
  @@index([name])
  @@index([isDefault])
  @@map("leave_policies")
}

// ============= DEPARTMENT MODEL =============
model Department {
  id          Int       @id @default(autoincrement())
  code        String    @unique @db.VarChar(20)
  name        String    @db.VarChar(100)
  description String?   @db.Text
  headId      Int?
  parentId    Int?
  isActive    Boolean   @default(true)

  // Self-referencing for hierarchy
  parent      Department? @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")

  // Relationships - FIXED: Add relation names
  head        User?     @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]    @relation("DepartmentUsers")

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Indexes
  @@index([code])
  @@index([name])
  @@index([headId])
  @@index([parentId])
  @@index([isActive])
  @@map("departments")
}